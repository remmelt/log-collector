---
- name: Install dependencies
  apt: state=present name=openjdk-7-jre-headless
  sudo: true

- name: Install Elasticsearch apt key
  apt_key:
    url=http://packages.elasticsearch.org/GPG-KEY-elasticsearch
    state=present
  sudo: yes

- name: Add Elasticsearch repository
  apt_repository:
    repo="deb http://packages.elasticsearch.org/elasticsearch/1.0/debian stable main"
    update_cache=yes
    state=present
  sudo: yes

- name: Install Elasticsearch
  apt:
    pkg=elasticsearch
    state=present
  sudo: yes

- name: Elasticsearch configuration
  template:
    src=elasticsearch.yml
    dest=/etc/elasticsearch/elasticsearch.yml
  sudo: yes
  notify: Restart Elasticsearch

- name: Elasticsearch logging configuration
  copy:
    src=logging.yml
    dest=/etc/elasticsearch/logging.yml
  sudo: yes
  notify: Restart Elasticsearch

- name: Ensure Elasticsearch is running
  service: name=elasticsearch state=started
  sudo: yes

- name: Register hostname with reverse proxy host
  lineinfile:
    state=present
    name=/etc/hosts
    line="{{ ip }} {{ inventory_hostname }}"
    regexp="[0-9.]*\s*{{ inventory_hostname }}"
  sudo: yes
  delegate_to: "{{ reverse_proxy_host }}"
